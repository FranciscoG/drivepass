var DrivePass=DrivePass||{};DrivePass.Browser={isChrome:function(){return/Chrome/.test(navigator.userAgent)},isFirefox:function(){return/Firefox/.test(navigator.userAgent)},sendToPage:function(a){var b=a||{};return 2!==Object.keys(b).length?!1:void(this.isChrome()&&chrome.tabs.getSelected(null,function(a){chrome.tabs.sendMessage(a.id,{password:b.password,username:b.username},function(a){console.log(a.dom)})}))},getActiveTab:function(a){this.isChrome()&&chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(b){var c=b[0];this.activeTabUrl=utils.getHostname(c.url),"function"==typeof a&&a()}.bind(this))},oAuthSendRequest:function(a,b,c){if(this.isChrome()){var d=chrome.extension.getBackgroundPage();d.oauth.sendSignedRequest(a,b,c)}}};var DrivePass=DrivePass||{};DrivePass.GoogleSpreadsheet=function(){var a,b={},c=function(a){var c=JSON.parse(a),d=0,e={},f=c.feed.entry,g=b.columns;for(var h in f){e[d]={};for(var i=0;i<g.length;i++){var j="gsx$"+g[i];e[d][g[i]]=f[h][j].$t}d++}return e},d=function(d,e){return 200!==e.status?(a={success:!1,message:e.status+": Connection Failed"},console.warn(e)):(a={success:!0,message:"spreadsheet successfully loaded"},a.sheetData=c(d)),DrivePass.Signal.broadcast("gs_data_loaded",a),null!==b.cb&&b.cb(a),a},e=function(a){b.cb="function"==typeof a?a:null;var c={headers:{"GData-Version":"3.0"},parameters:{alt:"json",showfolders:"true"}};DrivePass.Browser.oAuthSendRequest(b.jsonListUrl,d,c)},f=function(a,c){b.cb="function"==typeof c?c:null;var d={method:"POST",headers:{"GData-Version":"3.0","Content-Type":"application/atom+xml"},body:g(a)};DrivePass.Browser.oAuthSendRequest(b.jsonListUrl,h,d)},g=function(a){for(var c='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gsx="http://schemas.google.com/spreadsheets/2006/extended">\n',d=b.columns,e=0;e<d.length;e++)c+="<gsx:"+d[e]+">"+a[e]+"</gsx:"+d[e]+">\n";return c+="</entry>"},h=function(c,d){return 201!==d.status?(a={success:!1,message:d.status+": error saving"},console.warn(d)):a={success:!0,message:"saved successfully"},DrivePass.Signal.broadcast("gs_data_added",a),null!==b.cb&&b.cb(a),a},i=function(a){if(b=a||{},"string"!=typeof b.sheet_url||"object"!=typeof b.columns)throw new Error("Missing sheet_url or columns from init options");var c,d,e=b.sheet_url;if(e.match(/http(s)*:/)){c=e;try{d=c.match(/key=(.*?)(&|#)/)[1]}catch(f){d=c.match(/(cells|list)\/(.*?)\//)[2]}}else d=e;return b.jsonListUrl="https://spreadsheets.google.com/feeds/list/"+d+"/od6/private/full",b.jsonCellsUrl="https://spreadsheets.google.com/feeds/cells/"+d+"/od6/private/basic",this};return{init:i,load:e,add:f}};var DrivePass=DrivePass||{};DrivePass.Generator=function(){var a=document.getElementById("uppercase"),b=document.getElementById("lowercase"),c=document.getElementById("numbers"),d=document.getElementById("show_symbols"),e=document.getElementById("symbols"),f=document.getElementById("pw"),g=function(){var f="",g=0,h="",i=document.getElementById("digits").value||15;if(2>i&&(i=7),[a,b,c].forEach(function(a){if(a.checked===!0){h+=a.value;var b=a.value.length;f+=a.value.charAt(Math.floor(Math.random()*b)),g++}}),d.checked===!0){h+=e.value;var j=e.value.length;f+=e.value.charAt(Math.floor(Math.random()*j)),g++}return[i,h,f,g]},h=function(a){a.preventDefault();for(var b=g(),c=b[0]-b[3],d=b[1],e="",h=0,i=d.length;c>h;++h)e+=d.charAt(Math.floor(Math.random()*i));return e+=b[2],f.textContent=e,f.className="generated",!0},i=function(){document.getElementById("makePassword").addEventListener("click",h,!1)};return{init:i}};var DrivePass=DrivePass||{};DrivePass.Popup=function(){var a,b=document.getElementById("loading"),c=document.getElementById("status"),d=document.getElementById("un"),e=document.getElementById("pw"),f=document.getElementById("add"),g=document.getElementById("theInfo"),h=JSON.parse(localStorage.getItem("_data")),i=new DrivePass.GoogleSpreadsheet;i.init({sheet_url:localStorage.getItem("sheet_url"),columns:["site","username","password"]});var j=function(a,b){var c=a||{};if(Object.keys(c).length){for(var d in c)if(-1!==b.indexOf(c[d].site)){var e=[];return e.push(c[d].username,c[d].password),e}}else console.warn("findPW: data not an object")},k=function(a,b){var d=a||"",e=b||"";""!==d&&""!==e&&(c.textContent=e,c.className=d,c.style.display="block")},l=function(a){b.style.display="none",k("success","password found"),d.textContent=a[0],e.textContent=a[1],DrivePass.Browser.sendToPage({username:a[0],password:a[1]}),f.textContent="update"},m=function(){b.style.display="none",k("error","password not found"),utils.toggle(g)},n=function(){f.addEventListener("click",function(){var b=document.getElementById("un").textContent,c=document.getElementById("pw").textContent,d=[a,b,c];i.add(d,function(a){a.success===!1?k("error",a.message):k("success",a.message)})},!1)},o=function(){a=DrivePass.Browser.activeTabUrl;var b=j(h.sheetData,a);"undefined"==typeof b?m():l(b)},p=function(){null===h?(DrivePass.Signal.listen("gs_data_loaded",function(a,b){localStorage.setItem("_data",JSON.stringify(b)),b.success===!0&&(h=b,DrivePass.Browser.getActiveTab(o))}),i.load()):DrivePass.Browser.getActiveTab(o),n()};return{init:p}};var DrivePass=DrivePass||{};DrivePass.Router=function(){function a(a){this.methods=a,this.process()}return a.prototype.process=function(){this.methods.universal();var a=document.body.dataset.route;if("undefined"!=typeof a){var b=this.methods[a];"function"==typeof b&&b()}},a}();var DrivePass=DrivePass||{};DrivePass.Signal=function(){"use strict";var a={},b=-1,c=function(c,d){a[c]||(a[c]=[]);var e=(++b).toString();return a[c].push({token:e,func:d}),e},d=function(b,c){return a[b]?(setTimeout(function(){for(var d=a[b],e=d?d.length:0;e--;)d[e].func(b,c)},0),!0):!1},e=function(b){for(var c in a)if(a[c])for(var d=0,e=a[c].length;e>d;d++)if(a[c][d].token===b)return a[c].splice(d,1),b;return!1};return{broadcast:d,listen:c,stop:e}}();var utils={toggle:function(a){a.classList.contains("show")?a.classList.remove("show"):a.classList.add("show")},toggler:function(a,b){var c=this,d=document.getElementById(b);document.getElementById(a).addEventListener("click",function(){c.toggle(d)},!1)},getHostname:function(a){var b=a||"",c=document.createElement("a");return""!==b?(c.href=b,c.hostname):(console.warn("url undefined"),!1)}},DrivePass=DrivePass||{};DrivePass.ext=new DrivePass.Router({universal:function(){DrivePass.Settings=JSON.parse(localStorage.getItem("options"))||{},DrivePass.Settings.keeplocal=DrivePass.Settings.keeplocal||!0,DrivePass.Settings.route=document.body.dataset.route},popup:function(){var a=function(){utils.toggler("showGPoptions","gpOptions"),utils.toggler("showInfo","theInfo"),utils.toggler("show_symbols","hidden_symbols")},b=new DrivePass.Popup,c=new DrivePass.Generator;document.addEventListener("DOMContentLoaded",function(){this.bDone||(this.bDone=!0,c.init(),b.init(),a())})},chrome_options:function(){function a(){localStorage.setItem("sheet_url",document.getElementById("sheet_url").value),DrivePass.Signal.listen("gs_data_loaded",function(a,b){localStorage.setItem("_data",JSON.stringify(b))}),c.load(),document.getElementById("status").textContent="Options Saved."}function b(){var a=localStorage.getItem("sheet_url");if(null===a||""===a)return!1;document.getElementById("sheet_url").value=a,document.getElementById("save").textContent="update";var b=document.getElementById("goToSheet");b.href=a,b.style.display="block"}var c=new DrivePass.GoogleSpreadsheet;c.init({sheet_url:localStorage.getItem("sheet_url"),columns:["site","username","password"]}),document.addEventListener("DOMContentLoaded",b),document.getElementById("save").addEventListener("click",a)}});